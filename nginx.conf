server {
  listen 80;
  server_name _;

  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

  # Content Security Policy
  set $csp "default-src 'self'; \
    script-src 'self'; \
    style-src 'self' 'unsafe-inline'; \
    img-src 'self' data: https://*.kinopoisk.dev; \
    font-src 'self' data:; \
    connect-src 'self' https://api.kinopoisk.dev; \
    media-src https://youtube.com https://www.youtube.com https://youtu.be https://vimeo.com https://player.vimeo.com; \
    frame-src https://youtube.com https://www.youtube.com https://youtu.be https://vimeo.com https://player.vimeo.com;";
  add_header Content-Security-Policy $csp always;

  # Gzip/Brotli
  gzip on;
  gzip_comp_level 6;
  gzip_min_length 1024;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss application/xhtml+xml application/xml image/svg+xml;

  location /api/ {
    proxy_pass https://api.kinopoisk.dev/;
    proxy_set_header Host api.kinopoisk.dev;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_hide_header Access-Control-Allow-Origin;
    add_header Access-Control-Allow-Origin "*" always;
    proxy_set_header X-API-KEY $kinopoisk_api_key;
    limit_req zone=api_limit burst=20 nodelay;
  }

  # Static cache
  location ~* \.(?:js|css|woff2?|ttf|eot|svg|png|jpg|jpeg|gif|webp|avif)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # PWA assets
  location = /manifest.webmanifest { try_files $uri =404; }
  location = /robots.txt { try_files $uri =404; }
  location = /icon-192.png { try_files $uri =404; }
  location = /icon-512.png { try_files $uri =404; }

  # SPA fallback
  location / {
    try_files $uri /index.html;
  }
}


